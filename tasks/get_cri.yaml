---
- name: Geting CRI socket from host
  tags: getcri
  block:
  - name: CRI - Getting kubelet cmdline from proc
    shell:
      cmd: tr \\0 ' ' < /proc/"$(pgrep kubelet)"/cmdline
    register: kubelet_cmd

  - name: CRI - Getting CRI socket name
    set_fact:
      cri: '{{ (kubelet_cmd.stdout_lines[0] | regex_search("--container-runtime-endpoint=[:\w\/]{0,}")).split("=")[1].split("/run/")[1].split("/")[0] | trim }}'
    failed_when: cri not in ['containerd', 'docker']

  - name: CRI
    debug:
      msg: Detected CRI {{ cri }}
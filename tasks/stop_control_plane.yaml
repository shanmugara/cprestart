---
- name: Stop kubernetes api and manager pods
  block:
    - name: Read manifest file {{ item }}
      shell:
        cmd: "cat {{ item }}"
      register: manifest

    - name: Get static_pod name from manifest file
      set_fact:
        pod_name: "{{ manifest_yaml.metadata.name }}-{{ inventory_hostname }}"
      vars:
        manifest_yaml: "{{ manifest.stdout | from_yaml }}"

    - name: Fetch pod id for {{ pod_name }}
      shell:
        cmd: sudo crictl pods --name ^{{ pod_name }}$ --state ready -q
      register: pod_id
      changed_when: "pod_id is not failed"

    - name: Remove pod {{ pod_name }} from static_pod path
      file:
        path: "{{ item }}"
        state: absent

    - name: Waiting for pod {{ pod_name }} to stop
      shell:
        cmd: sudo crictl ps --state running -p {{ pod_id.stdout_lines[0] }} --no-trunc
      register: results
      until: results.stdout.find(pod_id.stdout_lines[0][:13]) == -1
      retries: 30
      delay: 5
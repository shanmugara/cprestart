---
- name: Kubernetes pods state check block
  tags: k8shealth
  block:
  - name: Kubernetes health - get list of pods not running in kube-system namespace
    shell:
      cmd: "kubectl get pods -n kube-system -o jsonpath='{.items[?(@.status.containerStatuses[*].ready==false)]}'|jq .metadata.name"
    register: pods
    until:  pods.stdout_lines|length == 0
    retries: '{{ retry_count }}'
    delay: '{{ retry_delay }}'

  - name: Kubernetes health - pods found not running in kube-system namespace
    debug:
      msg: 'PODS NOT RUNNING: {{ pods.stdout_lines }}'
    when: pods.stdout_lines|length > 0

  - name: Kubernetes health - all pods running block
    block:
    - name: Kubernetes health - all pods are running kube-system namespace
      debug:
        msg: 'ALL PODS ARE RUNNING IN KUBE-SYSTEM'
    - name: Kubernetes health - set fact
      set_fact:
        k8s_healthy: true
    when: pods.stdout_lines|length == 0

#     k get pods -o jsonpath='{.items[?(@.status.containerStatuses[*].ready==false)]}'